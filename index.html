      // 發送AI消息
      function sendAiMessage() {
        const input = document.getElementById('aiInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // 添加用戶消息到聊天歷史
        const chatHistory = document.getElementById('aiChatHistory');
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'user-message';
        userMessageDiv.textContent = message;
        chatHistory.appendChild(userMessageDiv);
        
        // 清空輸入框
        input.value = '';
        
        // 滾動到底部
        chatHistory.scrollTop = chatHistory.scrollHeight;
        
        // 顯示AI正在思考
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'ai-message';
        thinkingDiv.textContent = '思考中...';
        chatHistory.appendChild(thinkingDiv);
        
        // 發送請求到後端
        callGAS('aiChat', {
          token: currentUser.token,
          message: message,
          username: currentUser.username
        })
        .then(data => {
          // 移除"思考中"消息
          chatHistory.removeChild(thinkingDiv);
          
          if (data.success) {
            // 添加AI回應
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'ai-message';
            aiMessageDiv.textContent = data.response;
            chatHistory.appendChild(aiMessageDiv);
          } else {
            // 添加錯誤消息
            const errorDiv = document.createElement('div');
            errorDiv.className = 'ai-message';
            errorDiv.textContent = '抱歉，處理您的請求時發生錯誤。';
            chatHistory.appendChild(errorDiv);
            
            console.error('AI回應錯誤:', data.error);
            if (data.needLogin) {
              // 需要重新登入
              alert('您的登入已過期，請重新登入。');
              localStorage.removeItem('token');
              localStorage.removeItem('username');
              localStorage.removeItem('role');
              window.location.reload();
            }
          }
          
          // 滾動到底部
          chatHistory.scrollTop = chatHistory.scrollHeight;
        })
        .catch(err => {
          // 移除"思考中"消息
          chatHistory.removeChild(thinkingDiv);
          
          // 添加錯誤消息
          const errorDiv = document.createElement('div');
          errorDiv.className = 'ai-message';
          errorDiv.textContent = '抱歉，連接服務器時發生錯誤。';
          chatHistory.appendChild(errorDiv);
          
          console.error('AI請求錯誤:', err);
          
          // 滾動到底部
          chatHistory.scrollTop = chatHistory.scrollHeight;
        });
      }
      
      // 添加AI消息
      function addAiMessage(message) {
        const chatHistory = document.getElementById('aiChatHistory');
        const aiMessageDiv = document.createElement('div');
        aiMessageDiv.className = 'ai-message';
        aiMessageDiv.textContent = message;
        chatHistory.appendChild(aiMessageDiv);
        
        // 滾動到底部
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }
      
      // 顯示更改密碼模態視窗
      function showChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'block';
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordError').style.display = 'none';
      }
      
      // 關閉更改密碼模態視窗
      function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'none';
      }
      
      // 處理更改密碼
      function changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const passwordError = document.getElementById('passwordError');
        
        // 檢查輸入
        if (!currentPassword || !newPassword || !confirmPassword) {
          passwordError.textContent = '請填寫所有密碼欄位';
          passwordError.style.display = 'block';
          return;
        }
        
        if (newPassword !== confirmPassword) {
          passwordError.textContent = '新密碼與確認密碼不符';
          passwordError.style.display = 'block';
          return;
        }
        
        if (newPassword.length < 6) {
          passwordError.textContent = '新密碼長度至少需要6個字元';
          passwordError.style.display = 'block';
          return;
        }
        
        // 呼叫後端 API 更改密碼
        callGAS('changePassword', { 
          currentPassword: currentPassword,
          newPassword: newPassword,
          username: currentUser.username
        })
        .then(data => {
          if (data.success) {
            alert('密碼已成功更改！請使用新密碼重新登入。');
            closeChangePasswordModal();
            logoutUser(); // 更改密碼後登出
          } else {
            passwordError.textContent = data.error || '密碼更改失敗';
            passwordError.style.display = 'block';
          }
        })
        .catch(err => {
          console.error('更改密碼錯誤:', err);
          passwordError.textContent = '更改密碼時發生錯誤，請稍後再試';
          passwordError.style.display = 'block';
        });
      }
      
      // 調用 Google Apps Script
      function callGAS(action, params = {}) {
        const baseUrl = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';
        
        // 構建完整 URL
        let url = `${baseUrl}?action=${action}`;
        for (const key in params) {
          if (params.hasOwnProperty(key)) {
            url += `&${key}=${encodeURIComponent(params[key])}`;
          }
        }
        
        return fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          });
      }
    </script>
  </body>
</html>
